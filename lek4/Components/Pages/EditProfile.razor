@page "/edit-profile"
@using Firebase.Auth
@using System.Text.Json
@using System.Text
@using System.Net.Http
@inject FirebaseAuthClient AuthClient
@inject NavigationManager NavigationManager

<div class="settings-container">
    <h3>Edit Profile</h3>
    @if (profileModel != null)
    {
        <EditForm Model="profileModel" OnValidSubmit="UpdateProfile">
            <DataAnnotationsValidator />
            <ValidationSummary />
            <div class="info-item">
                <label for="firstName">First Name:</label>
                <InputText id="firstName" @bind-Value="profileModel.FirstName" />
            </div>
            <div class="info-item">
                <label for="lastName">Last Name:</label>
                <InputText id="lastName" @bind-Value="profileModel.LastName" />
            </div>
            <div class="info-item">
                <label for="birthDate">Birth Date:</label>
                <div class="date-picker">
                    <select @bind="selectedYear">
                        @foreach (var year in years)
                        {
                            <option value="@year">@year</option>
                        }
                    </select>
                    <select @bind="selectedMonth">
                        @foreach (var month in months)
                        {
                            <option value="@month.Value">@month.Key</option>
                        }
                    </select>
                    <select @bind="selectedDay">
                        @foreach (var day in days)
                        {
                            <option value="@day">@day</option>
                        }
                    </select>
                </div>
            </div>
            <div class="info-item">
                <label for="city">City:</label>
                <InputSelect id="city" @bind-Value="profileModel.City">
                    @foreach (var city in cities)
                    {
                        <option value="@city">@city</option>
                    }
                </InputSelect>
            </div>
            <div class="info-item">
                <label for="gender">Gender:</label>
                <InputSelect id="gender" @bind-Value="profileModel.Gender">
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Non-binary">Non-binary</option>
                    <option value="Prefer not to say">Prefer not to say</option>
                </InputSelect>
            </div>
            <div class="button-group">
                <button type="submit" class="save-button">Save</button>
            </div>
        </EditForm>
    }
    else
    {
        <p>Loading profile information...</p>
    }
</div>

@code {
    private User user;
    private ProfileModel profileModel = new ProfileModel();
    private int selectedYear;
    private int selectedMonth;
    private int selectedDay;

    private List<int> years = new List<int>();
    private Dictionary<string, int> months = new Dictionary<string, int>
    {
        {"January", 1},
        {"February", 2},
        {"March", 3},
        {"April", 4},
        {"May", 5},
        {"June", 6},
        {"July", 7},
        {"August", 8},
        {"September", 9},
        {"October", 10},
        {"November", 11},
        {"December", 12}
    };
    private List<int> days = Enumerable.Range(1, 31).ToList();

    private List<string> cities = new List<string>
    {
        "Stockholm",
        "Göteborg",
        "Malmö",
        "Uppsala",
        "Västerås",
        "Örebro",
        "Linköping",
        "Helsingborg",
        "Jönköping",
        "Norrköping",
        "Lund",
        "Umeå",
        "Gävle",
        "Borås",
        "Eskilstuna",
        "Södertälje",
        "Karlstad",
        "Täby",
        "Växjö",
        "Halmstad",
        "Sundsvall",
        "Luleå",
        "Trollhättan",
        "Östersund",
        "Borlänge",
        "Tumba",
        "Kalmar",
        "Skövde",
        "Karlskrona",
        "Kristianstad"
    };

    protected override async Task OnInitializedAsync()
    {
        user = AuthClient.User;
        await FetchUserProfile();
        for (int i = 1900; i <= DateTime.Now.Year; i++)
        {
            years.Add(i);
        }
        selectedYear = profileModel.BirthDate.Year;
        selectedMonth = profileModel.BirthDate.Month;
        selectedDay = profileModel.BirthDate.Day;
    }

    private async Task FetchUserProfile()
    {
        try
        {
            var client = new HttpClient();
            var response = await client.GetStringAsync($"https://firebasestorage.googleapis.com/v0/b/stega-426008.appspot.com/o/users%2F{user.Uid}.json?alt=media");
            profileModel = JsonSerializer.Deserialize<ProfileModel>(response);
        }
        catch (HttpRequestException httpEx)
        {
            Console.WriteLine($"HTTP Request Error: {httpEx.Message}");
            await Application.Current.MainPage.DisplayAlert("Error", $"Failed to load profile information: {httpEx.Message}", "Ok");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"General Error: {ex.Message}");
            await Application.Current.MainPage.DisplayAlert("Error", $"Failed to load profile information: {ex.Message}", "Ok");
        }
    }

    private async Task UpdateProfile()
    {
        try
        {
            profileModel.BirthDate = new DateTime(selectedYear, selectedMonth, selectedDay);
            var profileData = new
            {
                FirstName = profileModel.FirstName,
                LastName = profileModel.LastName,
                BirthDate = profileModel.BirthDate.ToString("yyyy-MM-dd"),
                City = profileModel.City,
                Gender = profileModel.Gender,
                Email = profileModel.Email
            };

            var json = JsonSerializer.Serialize(profileData);
            var content = new StringContent(json, Encoding.UTF8, "application/json");
            var client = new HttpClient();
            var response = await client.PutAsync($"https://firebasestorage.googleapis.com/v0/b/stega-426008.appspot.com/o/users%2F{user.Uid}.json?alt=media", content);

            if (!response.IsSuccessStatusCode)
            {
                var responseBody = await response.Content.ReadAsStringAsync();
                throw new Exception($"Failed to update profile: {responseBody}");
            }

            await Application.Current.MainPage.DisplayAlert("Success", "Profile updated successfully!", "Ok");
            NavigationManager.NavigateTo("/settings");
        }
        catch (Exception ex)
        {
            await Application.Current.MainPage.DisplayAlert("Error", $"Failed to update profile: {ex.Message}", "Ok");
        }
    }

    public class ProfileModel
    {
        public string FirstName { get; set; }
        public string LastName { get; set; }
        public DateTime BirthDate { get; set; }
        public string City { get; set; }
        public string Gender { get; set; }
        public string Email { get; set; }
    }
}

<style>
    .settings-container {
        max-width: 600px;
        margin: 40px auto;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 10px;
        background-color: #f9f9f9;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

        .settings-container h3 {
            text-align: center;
            color: #4a4a4a;
            margin-bottom: 20px;
        }

    .info-item {
        display: flex;
        justify-content: space-between;
        padding: 10px;
        border-bottom: 1px solid #ddd;
    }

        .info-item label {
            font-weight: bold;
            color: #555;
        }

        .info-item span,
        .info-item input,
        .info-item select {
            color: #333;
            flex: 1;
            text-align: right;
        }

        .info-item input,
        .info-item select {
            padding: 5px;
            margin-left: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

    .date-picker select {
        margin-right: 10px;
    }

    .button-group {
        display: flex;
        justify-content: center;
        margin-top: 20px;
    }

    .save-button {
        background-color: #d8bfea; /* Ljuslila färg */
        color: white;
        border: none;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        border-radius: 5px;
        transition: background-color 0.3s ease;
    }

        .save-button:hover {
            background-color: #c6a3e3; /* Mörkare nyans av ljuslila för hover-effekt */
        }
</style>
