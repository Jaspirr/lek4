@page "/"
@using Plugin.MauiMTAdmob
@using Plugin.MauiMTAdmob.Extra
@using System.Text.Json
@using lek4.Components.Pages
@inject NavigationManager NavigationManager
@inject lek4.Components.Service.NumberService NumberService
@inject GoogleFitService GoogleFitService
@inject UserService UserService
@inject Blazored.LocalStorage.ILocalStorageService localStorage
@inject IJSRuntime JSRuntime
@inject HttpClient HttpClient


<div class="home-container">
<!-- Info-knapp i övre vänstra hörnet -->
<button @onclick="ToggleInfoPopup" class="info-button">
    <i class="fas fa-info-circle"></i>
</button>

<!-- Info-popup -->
@if (showInfoPopup)
{
    <div class="popup-container">
        <div id="info-content">
            <div class="info-page active">
                <h3>What is the number 0.0?</h3>
                <p>
                    <br>1000 steps you take equals 0.1<br>
                    The more you move, the higher your chances. 
                    Once you've built up enough odds, you'll level up and get a credit <img src='images/Voidglas2.webp' alt='Voidglas Icon' class='inline-voidglas'/>
                    <br>Odds reset every week so everyone starts fresh — giving everyone the same chance each week!<br />
                </p>
            </div>

            <div class="info-page">
                <h3>What are credits for?</h3>
                <p><img src="images/Voidglas2.webp" alt="Voidglas Icon" class="inline-voidglas" /> are used to buy tickets for the <strong>BIG BANG draw</strong>.</p>
                <p>
                    The prize pool for <strong>BIG BANG</strong> grows based on how many <img src="images/Voidglas2.webp" alt="Voidglas Icon" class="inline-voidglas" /> <br>users collect together.<br />
                    Invite your friends to boost the amount!
                </p>
            </div>
            <div class="info-page compact">
                <h3>BIG BANG Jackpot</h3>
                <p>
                    Join the BIG BANG by locking in <strong>credits</strong> for a chance to win the full jackpot!
                </p>

                <h4>How it works:</h4>
                <ul class="info-list">
                    <li><strong>1.</strong> Lock in using <img src="images/Voidglas2.webp" alt="Voidglas Icon" class="inline-voidglas" /> credits.</li>
                    <li><strong>2.</strong> Each entry costs e.g. <span class="highlight-box">50</span> credits.</li>
                    <li><strong>3.</strong> Create your ticket after lock-in.</li>
                    <li><strong>4.</strong> A random ticket generates on draw day.</li>
                    <li>
                        <strong>5.</strong> Prizes by matches:
                        <ul class="sublist">
                            <li><strong>6/6:</strong> BIG BANG prize money win! 🎉</li>
                            <li><strong>5/6:</strong> Big prize (e.g. gift cards, premium products)</li>
                            <li><strong>4/6:</strong> Medium prize (gift cards, premium products or credits)</li>
                            <li><strong>3/6:</strong> Small prize (credits or mystery item)</li>
                            <li><strong>0–2:</strong> Maybe a smal credit bonus 💫</li>
                        </ul>
                    </li>
                </ul>
            </div>
            <div class="info-page">
                <h3>Create Your Ticket</h3>
                <p>
                    In 6 quick steps, you build your unique ticket for the <strong>BIG BANG draw</strong>:
                    <br /><br />
                    <div class="left-aligned-list">
                        <p><strong>1.</strong> Pick a number (1–50)</p>
                        <p><strong>2.</strong> Choose a color</p>
                        <p><strong>3.</strong> Select a symbol (like <i class="fas fa-star"></i>, <i class="fas fa-dragon"></i>, <i class="fas fa-bolt"></i>)</p>
                        <p><strong>4.</strong> Pick a star sign</p>
                        <p><strong>5.</strong> Choose a planet 🌍🪐</p>
                        <p><strong>6.</strong> Pick an element (Earth, Fire, Water, Air)</p>
                    </div>
                </p>
                <p>
                    Your combo = your ticket.<br />
                    The more tickets you hold, the higher your chance to win BIG!
                </p>
            </div>
            <div class="info-page">
                <h3>How do  <i class="fas fa-boxes"></i> page work?</h3>
                <p>
                    On this page, you’ll find <strong>BIG BANG</strong> and different products you can unlock based on your current <strong>Credits</strong> value or <strong>Odds</strong> level.
                </p>
                <p>
                    Some products require you to collect enough odds, while others — like special prices — show a number like this:
                    <span class="outcome-box inline-box"><span class="outcome-text">3</span></span>
                    This means you need to match 3 answers correctly in the <strong>BIG BANG draw</strong> to win the reward.
                </p>
                <p>
                    When your <strong>Credits</strong> or <strong>Odds</strong> match the product’s requirement, then you can <strong>LOCK IN</strong> to get the chance to win.
                </p>
            </div>
            <div class="info-page">
                <h3>How do <i class="fas fa-hand-holding-heart"></i> page work?</h3>
                <p>
                    <br>The <i class="fas fa-hand-holding-heart"></i> page lets you collect even more credits
                    through daily rewards, helping friends, charities, and other events <br/>
                    <br>It's the good way to boost your chances in the <strong>BIG BANG draw</strong>!<br />
                </p>
            </div>
        </div>


        <!-- Navigeringspilar -->
        <div class="carousel-controls">
            <button class="nav-button" onclick="previousPage()">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="nav-button" onclick="nextPage()">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>

        <button class="close-button" @onclick="ToggleInfoPopup">Close</button>
    </div>
}
 <div class="credits-box">
      <!-- Credits display in top-right corner -->

        <div class="star-wrapper @starAnimationClass">
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
            <img src="images/Voidglas2.webp" alt="Starshard Icon" class="voidglas-icon" />
        </div>
        <span class="credits-count">@credits</span>
    </div>
<div class="home-container" style="background-color: @(GetBackgroundColor())">

    <!-- Tre lager av förvrängda cirklar -->
   

   <div class="main-number-container">
    <div class="oval-background oval-background-layer1" style="background-color: @(GetNextColor())"></div>
    <div class="oval-background oval-background-layer2"></div>
    <div class="oval-background oval-background-layer3"></div>

   <div class="main-number-wrapper">
    <div class="main-number @explodeClass">
        <span class="main-number-value @GetSizeClass()">
                        @number.ToString("0.0x")
        </span>
    </div>
</div>

            @if (ShouldShowLockIcon())
            {
            <i class="fas fa-lock lock-icon" @onclick="() => UnlockAd()"></i>
            }
            @if (adReadyToWatch)
            {
            <i class="fas fa-unlock unlock-icon visible" @onclick="ShowAd"></i>
            }
</div>

    <div class="step-count">
        Steps: @steps
    </div>
</div>

<StepCounter OnStepsChanged="UpdateNumber" />
@if (isAdmin)
{
<div>
    <button @onclick="DecrementNumber">-</button>
    <span>@number.ToString("0.0")</span>
    <button @onclick="IncrementNumber">+</button>
</div>
<div class="update-credits-section">
    <label for="creditsInput">Ange nya credits:</label>
    <input type="number" id="creditsInput" @bind="newCredits" min="0" />
    <button @onclick="UpdateUserCredits">Uppdatera Credits</button>
</div>

        <button @onclick="FetchStepsFromGoogleFit">Fetch Steps from Google Fit</button>
        <button @onclick="ShowAd">Watch Ad</button> <!-- Button to show ad -->
        <button @onclick="GoToAdminPage">Admin Page</button> <!-- Button to navigate to Admin Page -->
}


@if (!string.IsNullOrEmpty(message))
{
    <div class="alert">@message</div>
}
</div>
<style>
.credits-box {
    position: fixed;
    top: env(safe-area-inset-top, 10px);
    right: 10px; 
    display: flex;
    align-items: center;
    background-color: #F0FFF0;
    padding: 8px 12px;
    border-radius: 20px;
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
    font-weight: bold;
    font-size: 16px;
    color: #333;
    z-index: 999;
}

.star-wrapper {
    position: relative;
    display: inline-block;
    margin-right: 8px;
}

.credits-icon {
    font-size: 20px;
        width: 20px; /* Adjust to fit the box */
        height: 20px;
        color: #ffca28; /* Gold color for icon */
}

    .credits-count {
        font-size: 16px;
        background-color: #F0FFF0; /* White background for circle */
        color: #333; /* Text color */
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%; /* Makes it a circle */
        box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);
        font-size: 16px;
}

/* Animation class */
    .animate-star {
        animation: flyToRightSmooth 1.5s ease-in-out forwards; /* Increased duration for smoother effect */
    }

@@keyframes flyToRightSmooth {
    0% {
        transform: translateX(0);
        opacity: 1;
    }
    30% {
        transform: translateX(10px);
        opacity: 1;
    }
    60% {
        transform: translateX(20px);
        opacity: 0.8;
    }
    80% {
        transform: translateX(22px) scale(1.1);
        opacity: 0.6;
    }
    100% {
        transform: translateX(25px) scale(1.2);
        opacity: 0;
    }
}
    /* Stil för info-knappen */
    .info-button {
        position: absolute;
        top: 50px;
        left: 10px;
        background: none;
        border: none;
        color: gainsboro;
        font-size: 1.5rem;
        cursor: pointer;
    }

        .info-button:hover {
            transform: scale(1.1);
            color: darkolivegreen;
        }

    /* Stil för popup */
    /* Stil för popup */
    .popup-container {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        text-align: center;
        max-width: 320px;
        width: 90%;
    }

    /* Navigeringsknappar */
    .carousel-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 100px; /* Lägger till mellanrum mellan pilarna */
        margin-top: 15px;
    }

    /* Stil för pilar */
    .nav-button {
        background: none;
        border: none;
        font-size: 2rem;
        cursor: pointer;
        transition: transform 0.2s ease-in-out, color 0.2s ease-in-out;
    }

        .nav-button i {
            color: darkolivegreen; /* Färg på pilar */
            transition: color 0.2s ease-in-out;
        }

        /* Effekt vid hover */
        .nav-button:hover i {
            transform: scale(1.3);
            color: black; /* Ändrar färg vid hover */
        }

    /* Sida-indikator */
    .page-indicator {
        font-size: 1rem;
        margin: 0 10px;
        font-weight: bold;
        color: #333;
    }

    /* Stäng-knapp */
    .close-button {
        background: darkolivegreen;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        margin-top: 10px;
    }

        .close-button:hover {
            background: #ff4d6d;
        }

    .left-aligned-list {
        text-align: left;
        margin: 0 auto;
        max-width: 300px; /* Optional, for clean layout */
    }
    /* Make outcome box inline-friendly */
    .inline-box {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #FFD700, #FFA500);
        color: white;
        font-size: 0.75rem;
        font-weight: bold;
        padding: 3px 6px;
        border-radius: 6px;
        margin: 0 6px;
        min-width: 24px;
        min-height: 24px;
        line-height: 1;
        vertical-align: middle;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
    }

        .inline-box .outcome-text {
            font-size: 0.85rem;
            font-weight: bold;
        }

    .info-page.compact {
        font-size: 0.85em;
        padding: 10px;
    }

    .info-page.compact .info-list {
        padding-left: 16px;
    }

    .info-page.compact .sublist {
        padding-left: 12px;
        font-size: 0.82em;
    }

    .inline-voidglas {
        width: 16px;
        height: 16px;
        vertical-align: middle;
    }

    .info-page {
        padding: 20px;
        max-width: 700px;
        margin: auto;
        color: #333;
        background-color: #fdfdfd;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .info-page h3 {
        font-size: 1.8em;
        color: #556B2F;
        margin-bottom: 10px;
    }

    .info-page h4 {
        margin-top: 20px;
        font-size: 1.3em;
        color: #333;
    }

    .info-list {
        list-style: none;
        padding-left: 0;
    }

        .info-list li {
            margin-bottom: 10px;
            line-height: 1.5;
        }

    .sublist {
        list-style-type: circle;
        margin-left: 20px;
        margin-top: 5px;
    }

    .highlight-box {
        display: inline-block;
        padding: 2px 8px;
        background-color: #556B2F;
        color: white;
        border-radius: 4px;
        font-weight: bold;
    }

    .jackpot-highlight {
        color: #b38b00;
        font-weight: bold;
    }

    .tip {
        margin-top: 20px;
        font-style: italic;
        color: #888;
    }

    .inline-voidglas {
        width: 20px;
        height: 20px;
        margin-bottom: -4px;
    }

    ul.info-list li {
        text-align: left;
    }

    ul.sublist {
        margin-top: 5px;
        margin-left: 20px;
        padding-left: 15px;
        list-style-type: disc; /* eller none om du vill ta bort punkterna */
        text-align: left;
    }

</style>
@code {
    private int credits = 0; 
    private string starAnimationClass = "";// Display credits in the UI
    private List<string> adminEmails = new();
    private bool isAdmin = false;
    private HashSet<double> AdTriggerPoints = new HashSet<double>();

    private double number
    {
        get => Math.Round((double)NumberService.Number, 1); // Explicit typkonvertering till double
        set
        {
            NumberService.Number = Math.Round((double)value, 1); // Explicit typkonvertering till double
            CheckAndShowAd();
        }
    }
    private bool showInfoPopup = false;
    private int currentPage = 0;

    private string[] infoPages = new string[]
      {
        "Välkommen! Här kan du se din statistik och prestationer.",
        "För att öka dina odds, gå in varje dag och vara aktiv.",
        "Planeterna visar din framgång – fortsätt röra dig framåt!",
        "Du kan tjäna Starshards genom att hålla en streak!",
        "Lycka till och fortsätt framåt!"
      };

    private void ToggleInfoPopup()
    {
        showInfoPopup = !showInfoPopup;
    }

    private void NextPage()
    {
        currentPage = (currentPage + 1) % infoPages.Length; // Går runt i en loop
    }

    private void PreviousPage()
    {
        currentPage = (currentPage - 1 + infoPages.Length) % infoPages.Length; // Går runt i en loop
    }

    private int steps = 0;
    private string explodeClass = string.Empty;
    private string message;
    private bool adWatched = false;
    private bool adReadyToWatch = false;
  
   private async Task FetchAdTriggerPoints()
{
    try
    {
        // URL to the JSON file in Firebase
        var configUrl = "https://firebasestorage.googleapis.com/v0/b/stega-426008.appspot.com/o/users%2Fads%2FAdsSpan.json?alt=media";
        var response = await HttpClient.GetStringAsync(configUrl);
        var config = JsonSerializer.Deserialize<AdConfiguration>(response);

        if (config != null && config.TriggerPoints != null)
        {
            AdTriggerPoints = new HashSet<double>(config.TriggerPoints);
            Console.WriteLine($"Fetched AdTriggerPoints: {string.Join(", ", AdTriggerPoints)}");
        }
        else
        {
            Console.WriteLine("No AdTriggerPoints found in the configuration file.");
            AdTriggerPoints = new HashSet<double>();
        }
    }
    catch (Exception ex)
    {
        Console.WriteLine($"Error fetching AdTriggerPoints: {ex.Message}");
    }
}

// Class to match the JSON structure
private class AdConfiguration
{
    public List<double> TriggerPoints { get; set; }
    public string SelectedPreset { get; set; }
}


    private const string RewardedAdUnitId = "ca-app-pub-3940256099942544/5224354917";
    private int newCredits; // Variabel för att hålla det nya kreditvärdet

    private async Task UpdateUserCredits()
    {
        var email = await localStorage.GetItemAsync<string>("userEmail");

        if (string.IsNullOrEmpty(email))
        {
            Console.WriteLine("No email found in local storage.");
            return;
        }

        // Uppdatera användarens credits i Firebase
        bool isUpdated = await UserService.UpdateUserCredits(email, newCredits);

        if (isUpdated)
        {
            credits = newCredits; // Uppdatera UI med nya värdet
            Console.WriteLine($"Credits for {email} updated to {newCredits}.");
        }
        else
        {
            Console.WriteLine($"Failed to update credits for {email}.");
        }
    }

    protected override async Task OnInitializedAsync()
    {
        base.OnInitialized();
        InitializeAds();

        // Fetch credits specifically for the credits display box
        await FetchCreditsForDisplay();
        await CheckIfUserIsAdmin();
        await FetchAdTriggerPoints();
    }
    private async Task CheckIfUserIsAdmin()
    {
        try
        {
            // Hämta den inloggade användarens e-post från LocalStorage
            var userEmail = await localStorage.GetItemAsync<string>("userEmail");

            if (string.IsNullOrEmpty(userEmail))
            {
                Console.WriteLine("No email found in local storage.");
                return;
            }

            // URL till adminlistan i Firebase Storage
            var adminFileUrl = "https://firebasestorage.googleapis.com/v0/b/stega-426008.appspot.com/o/admins%2Falladmins.json?alt=media";

            // Hämta adminlistan
            var response = await HttpClient.GetStringAsync(adminFileUrl);
            adminEmails = JsonSerializer.Deserialize<List<string>>(response) ?? new List<string>();

            // Kontrollera om användarens e-post finns i adminlistan
            isAdmin = adminEmails.Contains(userEmail);

            Console.WriteLine($"User is admin: {isAdmin}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error checking admin status: {ex.Message}");
        }
    }
    private async Task FetchCreditsForDisplay()
    {
        var email = await localStorage.GetItemAsync<string>("userEmail");

        if (string.IsNullOrEmpty(email))
        {
            Console.WriteLine("No email found in local storage.");
            credits = 0;
            return;
        }

        var user = await UserService.GetUserFromFirebase(email);
        var newCredits = user?.Credits ?? 0;

        // Avrunda och konvertera till int
        credits = (int)Math.Round((double)newCredits, 1); // Explicit konvertering till double

        // Check if credits have increased to trigger animation
        if (newCredits > credits)
        {
            TriggerStarAnimation();
        }

        StateHasChanged(); // Ensure UI updates
    }

    private void TriggerStarAnimation()
    {
        // Trigger animation class
        starAnimationClass = "animate-star";
        StateHasChanged();

        // Reset animation class after a short delay to allow re-triggering
        Task.Delay(1000).ContinueWith(_ =>
        {
            starAnimationClass = "";
            InvokeAsync(StateHasChanged);
        });
    }
    private async void UnlockAd()
    {
        adReadyToWatch = true;
        StateHasChanged();
        await Task.Delay(1000);
        ShowAd();

        // Retrieve email from localStorage
        var email = await localStorage.GetItemAsync<string>("userEmail");

        // Lägg till en kredit till användaren
        if (!string.IsNullOrEmpty(email))
        {
            await UserService.AddCreditToUser(email, 1); // Kalla metoden direkt utan tilldelning
            await FetchCreditsForDisplay(); // Uppdatera credits i UI
        }
        else
        {
            Console.WriteLine("User email not found in localStorage.");
        }
    }

    private void InitializeAds()
    {
        CrossMauiMTAdmob.Current.OnRewardedLoaded += OnRewardedAdLoaded;
        CrossMauiMTAdmob.Current.OnRewardedFailedToLoad += OnRewardedAdFailedToLoad;
        CrossMauiMTAdmob.Current.OnRewardedFailedToShow += OnRewardedFailedToShow;
        CrossMauiMTAdmob.Current.OnRewardedOpened += OnRewardedOpened;
        CrossMauiMTAdmob.Current.OnRewardedClosed += OnRewardedClosed;
        CrossMauiMTAdmob.Current.OnRewardedImpression += OnRewardedImpression;
        CrossMauiMTAdmob.Current.OnUserEarnedReward += OnUserEarnedReward;
    }
    private string[] colorSequence = new string[]
      {
        "#98FB98", // PaleGreen
        "#FF1493", // DeepPink
        "#cc99ff", // LightPurple
        "#7FFF00", // Chartreuse
        "#FFFF00", // Yellow
        "#ffcc99", // Peach
        "#ffff99", // LightYellow
        "#99ccff", // LightBlue
        "#99ff99"  // LightGreen
      };

    private string GetNextColor()
    {
        int colorIndex = Math.Min((int)number, colorSequence.Length - 1);
        return colorSequence[colorIndex];
    }

    private void OnRewardedImpression(object sender, EventArgs e)
    {
        Console.WriteLine("On Reward Impression");
    }

    private void OnRewardedClosed(object sender, EventArgs e)
    {
        Console.WriteLine("On Reward Closed");
        adReadyToWatch = false;
        StateHasChanged();
    }

    private void OnRewardedOpened(object sender, EventArgs e)
    {
        Console.WriteLine("On Reward Opened");
    }

    private void OnUserEarnedReward(object sender, MTEventArgs e)
    {
        Console.WriteLine($"User Earned Reward: {e.RewardType} - {e.RewardAmount}");
        adWatched = true;
        adReadyToWatch = false;
        StateHasChanged(); // Update the UI to reflect the change
    }

    private void OnRewardedFailedToShow(object sender, MTEventArgs e)
    {
        Console.WriteLine($"Reward Failed To Show: {e.ErrorCode} - {e.ErrorMessage}");
    }

    private void OnRewardedAdLoaded(object sender, EventArgs e)
    {
        Console.WriteLine("Rewarded Ad Loaded");
        adReadyToWatch = true;
        StateHasChanged(); // Update the UI to reflect the change
    }

    private void OnRewardedAdFailedToLoad(object sender, MTEventArgs e)
    {
        Console.WriteLine($"Rewarded Ad Failed To Load: {e.ErrorCode} - {e.ErrorMessage}");
    }

    private void UpdateNumber(int stepCount)
    {
        steps = stepCount;
        number = Math.Round(steps / 1000.0, 1);
        TriggerExplosionEffect();
    }

    private void TriggerExplosionEffect()
    {
        explodeClass = "explode";
        StateHasChanged();
        Task.Delay(600).ContinueWith(_ =>
        {
            explodeClass = string.Empty;
            InvokeAsync(StateHasChanged);
        });
    }

    private async Task FetchStepsFromGoogleFit()
    {
        try
        {
            await GoogleFitService.InitializeServiceAsync();
            DateTime startDate = DateTime.Now.AddDays(-7);
            DateTime endDate = DateTime.Now;
            steps = await GoogleFitService.GetTotalStepsAsync(startDate, endDate);
            UpdateNumber(steps);
            message = $"Total steps in the last week: {steps}";
        }
        catch (Exception ex)
        {
            message = $"Error: {ex.Message}";
        }
    }

    public string GetProductUrl()
    {
        return $"/products/{number:F1}";
    }

    private string GetBackgroundColor()
    {
        if (number >= 9.0) return "#98FB98"; // PaleGreen
        if (number >= 8.0) return "#FF1493"; // DeepPink
        if (number >= 7.0) return "#cc99ff"; // LightPurple
        if (number >= 6.0) return "#7FFF00"; // Chartreuse
        if (number >= 5.0) return "#FFFF00"; // Yellow
        if (number >= 4.0) return "#ffcc99"; // Peach
        if (number >= 3.0) return "#ffff99"; // LightYellow
        if (number >= 2.0) return "#99ccff"; // LightBlue
        if (number >= 1.0) return "#99ff99"; // LightGreen
        return "#ffffff"; // White
    }

    private string GetSizeClass()
    {
        if (number >= 9.0) return "size-9";
        if (number >= 8.0) return "size-8";
        if (number >= 7.0) return "size-7";
        if (number >= 6.0) return "size-6";
        if (number >= 5.0) return "size-5";
        if (number >= 4.0) return "size-4";
        if (number >= 3.0) return "size-3";
        if (number >= 2.0) return "size-2";
        if (number >= 1.0) return "size-1";
        return "size-0";
    }
    private async void IncrementNumber()
    {
        if (ShouldShowLockIcon())
        {
            message = "Please watch the ad to continue.";
            return;
        }

        var previousNumber = number; // Spara det gamla värdet
        number = Math.Round((double)Math.Min(number + 0.1, 9.0), 1); // Avrunda till double

        if (number > previousNumber) // Kontrollera om talet faktiskt ökades
        {
            await UpdateTotalOdds(number - previousNumber); // Lägg till skillnaden i totalodds
        }

        Console.WriteLine($"Number incremented to: {number}");
        adWatched = false; // Reset flag
    }

    private void DecrementNumber()
    {
        number = Math.Round((double)Math.Max(number - 0.1, 0.0), 1); // Avrunda till double
        Console.WriteLine($"Number decremented to: {number}");
    }

    private void GoToProducts()
    {
        NavigationManager.NavigateTo(GetProductUrl());
    }

    private void CheckAndShowAd()
    {
        Console.WriteLine($"Checking if ad should be shown for number: {number}");
        // No need to show ad automatically
    }

    private void ShowAd()
    {
        ((MainPage)Application.Current.MainPage).LoadRewardedAd();
    }
    private void GoToAdminPage()
    {
        NavigationManager.NavigateTo("/admin"); // Replace with the correct route to your Admin page
    }

    private bool ShouldShowLockIcon()
    {
        // Check if the rounded number is in the list of trigger points
        return !adWatched && AdTriggerPoints.Contains(number) && !adReadyToWatch;
    }

    private bool ShouldShowUnlockIcon()
    {
        // Show unlock icon if ad is ready to watch
        return adReadyToWatch;
    }
    private async Task UpdateTotalOdds(double valueToAdd)
    {
        try
        {
            var email = await localStorage.GetItemAsync<string>("userEmail");
            if (string.IsNullOrEmpty(email))
            {
                Console.WriteLine("No email found in local storage.");
                return;
            }

            var userStats = await UserService.GetUserFromFirebase(email);

            if (userStats == null)
            {
                Console.WriteLine($"No user found for {email}, creating new...");

                userStats = new UserService.UserStats
                    {
                        UserEmail = email,
                        TotalOdds = Math.Round(valueToAdd, 1),
                        WeeklyOdds = Math.Round(valueToAdd, 1),
                        Credits = 0,
                        StarShards = 0,
                        LockInAmount = 0,
                        DailyStreak = new UserService.DailyStreak
                        {
                            CurrentStreak = 0,
                            LongestStreak = 0,
                            Stars = 0,
                            LastLoginDate = DateTime.MinValue
                        }
                    };
            }
            else
            {
                userStats.TotalOdds = Math.Round((double)(userStats.TotalOdds + valueToAdd), 1);
                userStats.WeeklyOdds = Math.Round((double)(userStats.WeeklyOdds + valueToAdd), 1);
            }

            await UserService.UpdateUserStatsInFirebase(email, userStats);

            Console.WriteLine($"Updated or created stats for {email}. TotalOdds: {userStats.TotalOdds}, WeeklyOdds: {userStats.WeeklyOdds}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating totalodds and weeklyodds: {ex.Message}");
        }
    }

}
<style>
    .voidglas-icon {
        width: 38px; /* Öka bredden för att göra den större */
        height: 38px; /* Anpassa höjden så att den matchar bredden */
        margin-right: 10px; /* Ge lite extra utrymme mellan ikonen och texten */
        border-radius: 50%; /* Gör bilden rund om den är fyrkantig */
        object-fit: cover; /* Behåll proportionerna för bilden */
        box-shadow: 0px 2px 6px rgba(0, 0, 0, 0.2); /* Förbättra skuggan något */
    }

    .info-page {
        display: none;
    }

        .info-page.active {
            display: block;
        }

    .inline-voidglas {
        width: 50px;
        height: 50px;
        vertical-align: middle;
        margin-left: 4px;
    }

</style>
<script>
    let currentPage = 0;

    function showPage(index) {
        const pages = document.querySelectorAll('.info-page');
        if (pages.length === 0) return;

        pages.forEach(p => p.classList.remove('active'));
        pages[index].classList.add('active');
    }

    function nextPage() {
        const pages = document.querySelectorAll('.info-page');
        currentPage = (currentPage + 1) % pages.length;
        showPage(currentPage);
    }

    function previousPage() {
        const pages = document.querySelectorAll('.info-page');
        currentPage = (currentPage - 1 + pages.length) % pages.length;
        showPage(currentPage);
    }

    // När popup öppnas - visa första sidan
    document.addEventListener('DOMContentLoaded', () => {
        showPage(0);
    });
</script>
<style>

.status-bar-safe-area {
    display: none;
}

@@supports (-webkit-touch-callout: none) {
    .status-bar-safe-area {
        display: flex;
        position: sticky;
        top: 0;
        height: env(safe-area-inset-top);
        background-color: #f7f7f7;
        width: 100%;
        z-index: 1;
    }

    .flex-column, .navbar-brand {
        padding-left: env(safe-area-inset-left);
    }
}

@@keyframes pulse {
   0%, 100% {
        transform: scale(1);
    }

    50% {
        transform: scale(1.1);
    }
}

@@keyframes explode {
    0% {
        transform: scale(1);
        opacity: 1;
    }

    30% {
        transform: scale(2);
        opacity: 0;
    }

    100% {
        transform: scale(1);
        opacity: 1;
    }
}


.main-number-wrapper {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 3;
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%; 
    height: 100%;
    pointer-events: none; /* Gör så att t.ex. låsikoner fortfarande går att klicka */
}

.main-number {
    animation: pulse 4s ease-in-out infinite alternate;
    pointer-events: auto;
}

.main-number-value {
    display: inline-block;
    font-size: 3rem;
    text-align: center;
}
    .main-number.explode {
        animation: explode 0.6s ease;
    }

/* Style the lock icon to be larger and positioned over the number */
.lock-icon {
    font-size: 50px;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 10;
    cursor: pointer;
}

.unlock-icon {
    font-size: 50px;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 10;
    cursor: pointer;
    color: inherit; /* Ensure it has the same color as the lock icon */
    transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out; /* Adjust the transition speed */
    opacity: 0; /* Start hidden */
}

    .unlock-icon.visible {
        opacity: 1; /* Make visible with transition */
        transform: translate(-50%, -50%) scale(1); /* Maintain the same scale */
    }

.step-count {
    font-size: 1rem;
    margin-top: 10px;
}

.size-0 {
    transform: scale(1);
    font-size: 2rem;
}

.size-1 {
    transform: scale(1.1);
    font-size: 2.5rem;
}

.size-2 {
    transform: scale(1.2);
    font-size: 3rem;
}

.size-3 {
    transform: scale(1.3);
    font-size: 3.5rem;
}

.size-4 {
    transform: scale(1.4);
    font-size: 4rem;
}

.size-5 {
    transform: scale(1.5);
    font-size: 4.5rem;
}

.size-6 {
    transform: scale(1.6);
    font-size: 5rem;
}

.size-7 {
    transform: scale(1.7);
    font-size: 5.5rem;
}

.size-8 {
    transform: scale(1.8);
    font-size: 6rem;
}

.size-9 {
    transform: scale(1.9);
    font-size: 6.5rem;
}

.controls button {
    font-size: 2rem;
    margin: 5px;
    padding: 10px 20px;
}
.oval-background {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 150px;
    height: 150px;
    border-radius: 50%;
    opacity: 0.5;
    z-index: 0;
    animation: morphPulse 4s infinite ease-in-out alternate;
}

/* Varianter för varje cirkel för att få dem att pulsera vid olika tidpunkter */
.oval-background-layer1 {
    background-color: @GetNextColor(); /* eller dynamisk inline-stil via Blazor */
    z-index: 1;
    animation-delay: 0s;
}

.oval-background-layer2 {
    background-color: rgba(153, 204, 255, 0.6); /* Blå */
    animation-delay: 1s;
}

.oval-background-layer3 {
    background-color: rgba(255, 204, 153, 0.6); /* Peach */
    animation-delay: 2s;
}

/* Animation för att skapa pulserande och nästan triangelformad effekt */
@@keyframes morphPulse {
    0%, 100% {
        transform: translate(-50%, -50%) scale(1) rotate(0deg);
        border-radius: 50%; /* Full cirkel */
    }

    50% {
        transform: translate(-50%, -50%) scale(1.1) rotate(10deg);
        border-radius: 45% 55% 50% 50% / 50% 50% 45% 55%; /* Nästan triangel */
    }
}

.locked {
    background-color: silver; /* Silvrig färg när låst */
}

.locked-in {
    background-color: gold; /* Guldglitter när upplåst */
    animation: shimmer 2s infinite;
}
.product {
    position: relative;
    transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out, background-color 0.5s;
    transform: rotate(45deg);
    border: 1px solid #000000;
    border-radius: 10px;
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

    .product::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: inherit;
        background-size: contain;
        background-position: center;
        background-repeat: no-repeat;
        transform: scale(1.3) rotate(-45deg); /* Counter rotate to keep background upright */
        z-index: 1;
    }

    /* Klass för vinnande produkter */
    .product.gold {
        background-color: gold; /* Guld bakgrundsfärg för vinnare */
        box-shadow: 0 0 15px 5px rgba(255, 215, 0, 0.8); /* Glow-effekt */
        border: none; /* Ta bort border för vinnare */
        animation: shimmer 2s infinite;
    }


.icon-wrapper {
    position: relative;
    z-index: 2;
    transform: rotate(-45deg); /* Ser till att ikonen står upprätt */
}

/* Större och guldfärgad ikon för vinnare */
.product.gold .icon-wrapper i {
    font-size: 1.4em; /* Justera storlek efter behov */
    color: #F0FFF0; /* Guldton för trofé */
    text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.3); /* Skugga för djup */
}
/* Standard ikonstil */
.icon-wrapper i {
    font-size: 1.8em; /* Standardstorlek */
}

/* Shimmer-animation för vinnare */
@@keyframes shimmer {
    0% {
        box-shadow: 0 0 5px gold;
    }

    50% {
        box-shadow: 0 0 20px gold;
    }

    100% {
        box-shadow: 0 0 5px gold;
    }
}

.product.unlocking {
    animation: spinAndScale 0.7s ease-in-out;
}

@@keyframes spinAndScale {
    0% {
        transform: scale(1) rotate(45deg);
    }

    50% {
        transform: scale(1.15) rotate(225deg);
    }

    100% {
        transform: scale(1) rotate(405deg);
    }
}

.product-1 {
    background-color: rgba(221, 160, 221, 0.8); /* Ljuslila */
}

.product-2 {
    background-color: rgba(221, 160, 221, 0.8); /* Ljuslila */
}

.product-3 {
    background-color: rgba(221, 160, 221, 0.8); /* Ljuslila */
}

.product-4 {
    background-color: rgba(221, 160, 221, 0.8); /* Ljuslila */
}

.product-5 {
    background-color: rgba(221, 160, 221, 0.8); /* Ljuslila */
}

.product-6 {
    background-color: rgba(221, 160, 221, 0.8); /* Ljuslila */
}

.product-7 {
    background-color: rgba(221, 160, 221, 0.8); /* Ljuslila */
}

.product-8 {
    background-color: rgba(221, 160, 221, 0.8); /* Ljuslila */
}

.product-9 {
    background-color: rgba(221, 160, 221, 0.8); /* Ljuslila */
}

.product:nth-child(1) {
    grid-column: 3 / span 1; /* Center the first product */

}

.product:nth-child(2),
.product:nth-child(3) {
    grid-column: span 1;
}

.product:nth-child(2) {
    grid-column: 2; /* Position second product in second column */
}

.product:nth-child(3) {
    grid-column: 4; /* Position third product in fourth column */
}

.product:nth-child(4),
.product:nth-child(5),
.product:nth-child(6) {
    grid-column: span 1;
}

.product:nth-child(4) {
    grid-column: 1; /* Position fourth product in first column */
}

.product:nth-child(5) {
    grid-column: 3; /* Position fifth product in third column */
}

.product:nth-child(6) {
    grid-column: 5; /* Position sixth product in fifth column */
}

.product:nth-child(7),
.product:nth-child(8) {
    grid-column: span 1;
}

.product:nth-child(7) {
    grid-column: 2; /* Position seventh product in second column */
}

.product:nth-child(8) {
    grid-column: 4; /* Position eighth product in fourth column */
}

.product:nth-child(9) {
    grid-column: 3; /* Position ninth product in third column */
}

.product-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr); /* 5 kolumner */
    grid-template-rows: auto; /* Automatisk höjd för rader */
    gap: 5px; /* Minska mellanrummet */
    justify-items: center;
    margin: 120px auto;
    max-width: 100%; /* Full bredd så att alla produkter passar på skärmen */
}



    /* Större storlek för produkt 1 */
    .product:nth-child(1) {
        grid-column: 3; /* Center the first product */
        grid-row: 1;
        width: 130px; /* Första produkten är större */
        height: 130px;
    }

    /* Placering av produkt 2 och 3 */
    .product:nth-child(2) {
        grid-column: 2;
        grid-row: 2;
    }

    .product:nth-child(3) {
        grid-column: 4;
        grid-row: 2;
    }

    /* Placera produkt 4 på rad 3 */
    .product:nth-child(4) {
        grid-column: 3; /* Under produkt 1 */
        grid-row: 3; /* Ny rad för produkt 4 */
    }

    /* Placera produkt 5 under produkt 2 */
    .product:nth-child(5) {
        grid-column: 2;
        grid-row: 4; /* Ny rad för produkt 5 */
    }

    /* Placera produkt 6 under produkt 3 */
    .product:nth-child(6) {
        grid-column: 4;
        grid-row: 4; /* Ny rad för produkt 6 */
    }

    /* Placera produkt 7 under produkt 4 */
    .product:nth-child(7) {
        grid-column: 3;
        grid-row: 5; /* Ny rad för produkt 7 under produkt 4 */
    }

    /* Placera produkt 8 under produkt 5 */
    .product:nth-child(8) {
        grid-column: 2;
        grid-row: 6; /* Ny rad för produkt 8 under produkt 5 */
    }

    /* Placera produkt 9 under produkt 6 */
    .product:nth-child(9) {
        grid-column: 4;
        grid-row: 6; /* Ny rad för produkt 9 under produkt 6 */
    }

.center-title {
    text-align: center;
    margin-top: 50px;
}

.remaining-odds {
    text-align: center;
}

.checkmark {
    font-size: 2em;
    color: black;
}

/* Centering titles */
.center-title {
    text-align: center;
    margin-top: 50px;
}

.center-subtitle {
    text-align: center;
    max-width: 60%;
    margin: 0 auto;
}

.stats-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    margin-top: 20px;
}

.stat-item {
    background-color: #cc99ff;
    border: 1px solid #ccc;
    border-radius: 5px;
    padding: 20px;
    text-align: center;
    width: 200px;
}

.progress-bar {
    background-color: #ccc;
    border-radius: 5px;
    overflow: hidden;
    height: 20px;
    width: 100%;
    margin-top: 10px;
}

.progress {
    background-color: #00ffff;
    height: 100%;
}
.home-container {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    min-height: 100vh;
    width: 100%;
    box-sizing: border-box;
    padding: 0;
    margin: 0;
    background: linear-gradient(145deg, #ffffff, #f4f4f9); /* eller valfri bakgrund */
    font-family: 'Inter', sans-serif;
}
.home-container {
    padding-top: env(safe-area-inset-top);
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
    padding-bottom: env(safe-area-inset-bottom);
}

</style>