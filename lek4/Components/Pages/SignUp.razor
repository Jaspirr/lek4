@page "/signup"
@using Firebase.Auth
@using System.Text.Json
@using System.Text
@using System.Net.Http
@inject FirebaseAuthClient AuthClient
@inject NavigationManager NavigationManager

<div class="signup-container">
    <div class="signup-form">
        <h3 class="signup-title">Sign Up</h3>
        <EditForm Model="signupModel" OnValidSubmit="RegisterUser">
            <DataAnnotationsValidator />
            <ValidationSummary />
            <div class="form-group">
                <label for="firstName">First Name:</label>
                <InputText id="firstName" @bind-Value="signupModel.FirstName" />
            </div>
            <div class="form-group">
                <label for="lastName">Last Name:</label>
                <InputText id="lastName" @bind-Value="signupModel.LastName" />
            </div>
            <div class="form-group">
                <label for="birthDate">Birth Date:</label>
                <div class="date-picker">
                    <select @bind="selectedYear">
                        @foreach (var year in years)
                        {
                            <option value="@year">@year</option>
                        }
                    </select>
                    <select @bind="selectedMonth">
                        @foreach (var month in months)
                        {
                            <option value="@month.Value">@month.Key</option>
                        }
                    </select>
                    <select @bind="selectedDay">
                        @foreach (var day in days)
                        {
                            <option value="@day">@day</option>
                        }
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="city">City:</label>
                <InputSelect id="city" @bind-Value="signupModel.City">
                    @foreach (var city in cities)
                    {
                        <option value="@city">@city</option>
                    }
                </InputSelect>
            </div>
            <div class="form-group">
                <label for="gender">Gender:</label>
                <InputSelect id="gender" @bind-Value="signupModel.Gender">
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Non-binary">Non-binary</option>
                    <option value="Prefer not to say">Prefer not to say</option>
                </InputSelect>
            </div>
            <div class="form-group">
                <label for="email">Email:</label>
                <InputText id="email" @bind-Value="signupModel.Email" />
            </div>
            <div class="form-group">
                <label for="password">Password:</label>
                <InputText id="password" @bind-Value="signupModel.Password" type="password" />
            </div>
            <div class="form-group">
                <label for="confirmPassword">Confirm Password:</label>
                <InputText id="confirmPassword" @bind-Value="signupModel.ConfirmPassword" type="password" />
            </div>
            <button class="signup-button" type="submit">Sign Up</button>
            <div class="signup-footer">
                Already have an account? <NavLink href="/login">Login here</NavLink>
            </div>
        </EditForm>
    </div>
</div>

@code {
    private SignupModel signupModel = new SignupModel
        {
            City = "Stockholm", // Standardvärde för City
            Gender = "Male"     // Standardvärde för Gender
        };
    private int selectedYear;
    private int selectedMonth;
    private int _selectedDay;
    private int selectedDay
    {
        get => _selectedDay;
        set
        {
            if (_selectedDay != value)
            {
                _selectedDay = value;
            }
        }
    }
    private List<int> days = Enumerable.Range(1, 31).ToList();
    private List<int> years = new List<int>();
    private Dictionary<string, int> months = new Dictionary<string, int>
    {
        {"January", 1},
        {"February", 2},
        {"March", 3},
        {"April", 4},
        {"May", 5},
        {"June", 6},
        {"July", 7},
        {"August", 8},
        {"September", 9},
        {"October", 10},
        {"November", 11},
        {"December", 12}
    };
    private List<string> cities = new List<string>
    {
        "Stockholm", "Göteborg", "Malmö", "Uppsala", "Västerås", "Örebro", "Linköping", "Helsingborg",
        "Jönköping", "Norrköping", "Lund", "Umeå", "Gävle", "Borås", "Eskilstuna", "Södertälje", "Karlstad",
        "Täby", "Växjö", "Halmstad", "Sundsvall", "Luleå", "Trollhättan", "Östersund", "Borlänge", "Tumba",
        "Kalmar", "Skövde", "Karlskrona", "Kristianstad"
    };

    protected override void OnInitialized()
    {
        base.OnInitialized();

        // Generera lista med år
        for (int i = 1900; i <= DateTime.Now.Year; i++)
        {
            years.Add(i);
        }

        // Sätt initiala värden
        selectedYear = DateTime.Now.Year;
        selectedMonth = DateTime.Now.Month;
        selectedDay = DateTime.Now.Day;

        // Uppdatera dagarna baserat på initial månad och år
        UpdateDays();
    }
    private void UpdateDays()
    {
        // Hämta antalet dagar i den valda månaden och året
        int daysInMonth = DateTime.DaysInMonth(selectedYear, selectedMonth);
        days = Enumerable.Range(1, daysInMonth).ToList();

        // Se till att vald dag inte överskrider det nya antalet dagar
        if (selectedDay > daysInMonth)
        {
            selectedDay = daysInMonth;
        }
    }

    private async Task RegisterUser()
    {
        signupModel.BirthDate = new DateTime(selectedYear, selectedMonth, selectedDay);

        // Kontrollera om användaren är minst 18 år
        if (CalculateAge(signupModel.BirthDate) < 18)
        {
            await Application.Current.MainPage.DisplayAlert("Error", "You must be at least 18 years old to sign up.", "Ok");
            return;
        }

        // Kontrollera om lösenorden matchar
        if (signupModel.Password != signupModel.ConfirmPassword)
        {
            await Application.Current.MainPage.DisplayAlert("Error", "Passwords do not match.", "Ok");
            return;
        }

        try
        {
            // Skapa användaren i Firebase Authentication
            var userCredential = await AuthClient.CreateUserWithEmailAndPasswordAsync(signupModel.Email, signupModel.Password);
            Console.WriteLine($"User created with UID: {userCredential.User.Uid}");

            // Spara användarprofilen i Firebase Storage
            await SaveUserProfileToStorage(userCredential.User);
            Console.WriteLine("User profile saved to storage.");

            // Bekräfta registrering
            await Application.Current.MainPage.DisplayAlert("Success", "Registration successful!", "Ok");
            NavigationManager.NavigateTo("/login");
        }
        catch (Exception ex)
        {
            // Fånga eventuella fel och visa ett felmeddelande
            Console.WriteLine($"Full Exception: {ex.ToString()}");
            var errorMessage = GetErrorMessage(ex.Message);
            await Application.Current.MainPage.DisplayAlert("Error", errorMessage, "Ok");
        }
    }

    // Metod för att spara användarprofil i Firebase Storage
    private async Task SaveUserProfileToStorage(User user)
    {
        var profileData = new
        {
            FirstName = signupModel.FirstName,
            LastName = signupModel.LastName,
            BirthDate = signupModel.BirthDate.ToString("yyyy-MM-dd"),
            City = signupModel.City,
            Gender = signupModel.Gender,
            Email = signupModel.Email
        };

        var json = JsonSerializer.Serialize(profileData);
        var content = new StringContent(json, Encoding.UTF8, "application/json");
        var client = new HttpClient();

        // Skicka förfrågan till Firebase
        var response = await client.PostAsync($"https://firebasestorage.googleapis.com/v0/b/stega-426008.appspot.com/o/users%2F{user.Uid}.json", content);

        var responseBody = await response.Content.ReadAsStringAsync();
        Console.WriteLine($"Firebase response: {responseBody}");

        // Kontrollera om responsen är JSON
        if (!responseBody.StartsWith("{"))
        {
            Console.WriteLine("Non-JSON response received.");
            throw new Exception($"Failed to save user profile: {responseBody}");
        }

        // Försök att deserialisera JSON om det är giltigt
        try
        {
            var responseJson = JsonSerializer.Deserialize<JsonElement>(responseBody);
            // Hantera JSON-svaret här
        }
        catch (JsonException ex)
        {
            Console.WriteLine($"Failed to parse JSON: {ex.Message}");
            throw new Exception($"Failed to parse Firebase response: {ex.Message}");
        }

        if (!response.IsSuccessStatusCode)
        {
            throw new Exception($"Failed to save user profile: {responseBody}");
        }
    }

    private string GetErrorMessage(string responseBody)
    {
        try
        {
            var responseJson = JsonSerializer.Deserialize<JsonElement>(responseBody);
            var error = responseJson.GetProperty("error").GetProperty("message").GetString();
            return error switch
            {
                "EMAIL_EXISTS" => "The email address is already in use by another account.",
                "INVALID_EMAIL" => "The email address is invalid.",
                "WEAK_PASSWORD" => "The password is too weak. Please use at least 6 characters.",
                _ => "An error occurred during sign up. Please try again."
            };
        }
        catch (JsonException ex)
        {
            Console.WriteLine($"Failed to parse JSON: {ex.Message}");
            return "An unexpected error occurred.";
        }
    }

    private int CalculateAge(DateTime birthDate)
    {
        var today = DateTime.Today;
        var age = today.Year - birthDate.Year;
        if (birthDate.Date > today.AddYears(-age)) age--;
        return age;
    }

    public class SignupModel
    {
        public string FirstName { get; set; }
        public string LastName { get; set; }
        public DateTime BirthDate { get; set; }
        public string City { get; set; }
        public string Gender { get; set; }
        public string Email { get; set; }
        public string Password { get; set; }
        public string ConfirmPassword { get; set; }
    }
}

<style>
    .signup-container {
        max-width: 400px;
        margin: 50px auto;
        padding: 25px;
        border: 1px solid #ddd;
        border-radius: 10px;
        background-color: #ffffff;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        font-family: 'Arial', sans-serif;
    }

    .signup-container h3 {
        text-align: center;
        color: #4a4a4a;
        font-size: 1.8em;
        margin-bottom: 20px;
        font-weight: 600;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        margin-bottom: 15px;
    }

    .form-group label {
        font-weight: bold;
        color: #555;
        margin-bottom: 5px;
    }

    .form-group input,
    .form-group select {
        padding: 10px;
        font-size: 1rem;
        border: 1px solid #ddd;
        border-radius: 5px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        width: 100%;
    }

    .form-group select {
        cursor: pointer;
        background-color: #f9f9f9;
    }

    .form-group input:focus,
    .form-group select:focus {
        border-color: #a882d6;
        outline: none;
        box-shadow: 0 0 5px rgba(168, 130, 214, 0.5);
    }

    .date-picker {
        display: flex;
        gap: 10px;
    }

    .date-picker select {
        flex: 1;
    }

    .signup-button {
        background-color: #556B2F; /* Ljuslila färg */
        color: #F0FFF0;
        border: none;
        padding: 12px 20px;
        font-size: 1rem;
        cursor: pointer;
        border-radius: 5px;
        transition: all 0.3s ease;
        width: 100%;
    }

    .signup-button:hover {
        background-color: #8b5fc1; /* Mörkare lila för hover */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        color: white;
    }

    .signup-button:disabled {
        background-color: #e3d7f1;
        cursor: not-allowed;
    }

    .signup-footer {
        text-align: center;
        margin-top: 15px;
        font-size: 0.9rem;
        color: #4a4a4a;
    }

    .signup-footer a {
        color: #8b5fc1;
        text-decoration: none;
        font-weight: 600;
    }

    .signup-footer a:hover {
        text-decoration: underline;
    }

    @@media (max-width: 480px) {
        .signup-container {
            padding: 15px;
            margin: 20px;
        }

        .form-group input,
        .form-group select {
            font-size: 0.9rem;
        }

        .signup-button {
            font-size: 0.9rem;
            padding: 10px 15px;
        }
    }
</style>
