@page "/"

@inject NavigationManager NavigationManager
@inject lek4.Components.Service.NumberService NumberService

<div class="container" style="background-color: @(GetBackgroundColor())">
    <div class="main-number @GetSizeClass() @explodeClass">
        @number.ToString("0.0")
    </div>
    <div class="step-count">
        Steps: @steps
    </div>
</div>

<StepCounter OnStepsChanged="UpdateNumber" />

<div>
    <button @onclick="DecrementNumber">-</button>
    <span>@number</span>
    <button @onclick="IncrementNumber">+</button>
    <button @onclick="GoToProducts">Go to Products</button>
</div>

@code {
    private double number
    {
        get => NumberService.CurrentNumber;
        set => NumberService.CurrentNumber = value;
    }
    private int steps = 0;
    private string explodeClass = string.Empty;

    private void UpdateNumber(int stepCount)
    {
        steps = stepCount;
        number = Math.Round(steps / 1000.0, 1);
        TriggerExplosionEffect();
    }

    private void TriggerExplosionEffect()
    {
        explodeClass = "explode";
        StateHasChanged();
        Task.Delay(600).ContinueWith(_ =>
        {
            explodeClass = string.Empty;
            InvokeAsync(StateHasChanged);
        });
    }

    public string GetProductUrl()
    {
        return $"/products/{number:F1}";
    }

    private string GetBackgroundColor()
    {
        if (number >= 9.0) return "#66ffcc";
        if (number >= 8.0) return "#ff9966";
        if (number >= 7.0) return "#ffff99";
        if (number >= 6.0) return "#ffccff";
        if (number >= 5.0) return "#cc99ff";
        if (number >= 4.0) return "#ffcc99";
        if (number >= 3.0) return "#FFFF00";
        if (number >= 2.0) return "#99ccff";
        if (number >= 1.0) return "#99ff99";
        return "#ffffff";
    }

    private string GetSizeClass()
    {
        if (number >= 5.0) return "size-5";
        if (number >= 4.0) return "size-4";
        if (number >= 3.0) return "size-3";
        if (number >= 2.0) return "size-2";
        if (number >= 1.0) return "size-1";
        return "size-0";
    }

    private void IncrementNumber()
    {
        number = Math.Min(number + 0.1, 9.9);
    }

    private void DecrementNumber()
    {
        number = Math.Max(number - 0.1, 0.0);
    }

    private void GoToProducts()
    {
        NavigationManager.NavigateTo(GetProductUrl());
    }
}
